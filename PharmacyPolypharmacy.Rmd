---
title: "Polypharmacy"
author: "Dr. David Fong"
date: "6th February 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Polypharmacy review benefits


## Extent of polypharmacy


### Rate of polypharmacy in patients who are 

SQL search code 

## Current strategies to combat polypharmacy



# Polypharmacy project

## Methods

* Identify polypharmacy

```{r message = FALSE, results = 'hide', warning = FALSE}
library(tidyverse)
library(lubridate)
library(xlsx)
library(openxlsx)
library(formattable)
library(kableExtra)
```

## Logframe



## Variables to measure

* **Age**
* **Refugee or asylum seeker** Possible proxy for less English literacy skills, or different health literacy.

# Data and Code

## Read Data

```{r}
population <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002Medication5plus.xlsx",
                                   startRow = 4, sheetIndex = 1,
                                   colClasses = c(ID = 'numeric'),
                                   stringsAsFactors = FALSE))
names(population) <- gsub("\\.", "", names(population)) # remove periods '.'
population <- population[-nrow(population),] %>%
  mutate(MedCount = as.numeric(MedCount))

refugeeorasylum <- as_tibble(read.csv("../../PEN Clinical Audit/20200206RefugeeAsylum.csv",
                                      stringsAsFactors = FALSE,
                                      colClasses = c(INTERNALID = 'numeric'))) %>%
  select(INTERNALID)

analgesia <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAnalgesia.xlsx",
                                  startRow = 4, sheetIndex = 1,
                                  colClasses = c(ID = 'numeric'),
                                  stringsAsFactors = FALSE))
names(analgesia) <- gsub("\\.", "", names(analgesia)) # remove periods '.'
analgesia <- analgesia[-nrow(analgesia),] %>%
  select(ID, Medications)

BP <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationBP.xlsx",
                           startRow = 4, sheetIndex = 1,
                           colClasses = c(ID = 'numeric'),
                           stringsAsFactors = FALSE))
names(BP) <- gsub("\\.", "", names(BP)) # remove periods '.'
BP <- BP[-nrow(BP),] %>%
  select(ID, Medications)

anticoagulant <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAnticoagulant.xlsx",
                                      startRow = 4, sheetIndex = 1,
                                      colClasses = c(ID = 'numeric'),
                                      stringsAsFactors = FALSE))
names(anticoagulant) <- gsub("\\.", "", names(anticoagulant)) # remove periods '.'
anticoagulant <- anticoagulant[-nrow(anticoagulant),] %>%
  select(ID, Medications)

hypoglycaemic <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationHypoglycaemic.xlsx",
                                      startRow = 4, sheetIndex = 1,
                                      colClasses = c(ID = 'numeric'),
                                      stringsAsFactors = FALSE))
names(hypoglycaemic) <- gsub("\\.", "", names(hypoglycaemic)) # remove periods '.'
hypoglycaemic <- hypoglycaemic[-nrow(hypoglycaemic),] %>%
  select(ID, Medications)

antipsychoticmood <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAntipsychoticMoodStabilizers.xlsx",
                                          startRow = 4, sheetIndex = 1,
                                          colClasses = c(ID = 'numeric'),
                                          stringsAsFactors = FALSE))
names(antipsychoticmood) <- gsub("\\.", "", names(antipsychoticmood)) # remove periods '.'
antipsychoticmood <- antipsychoticmood[-nrow(antipsychoticmood),] %>%
  select(ID, Medications)

antidepressant <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAntidepressant.xlsx",
                                       startRow = 4, sheetIndex = 1,
                                       colClasses = c(ID = 'numeric'),
                                       stringsAsFactors = FALSE))
names(antidepressant) <- gsub("\\.", "", names(antidepressant)) # remove periods '.'
antidepressant <- antidepressant[-nrow(antidepressant),] %>%
  select(ID, Medications)

antianxiety <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAntianxiety.xlsx",
                                    startRow = 4, sheetIndex = 1,
                                    colClasses = c(ID = 'numeric'),
                                    stringsAsFactors = FALSE))
names(antianxiety) <- gsub("\\.", "", names(antianxiety)) # remove periods '.'
antianxiety <- antianxiety[-nrow(antianxiety),] %>%
  select(ID, Medications)

respiratory <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationRespiratory.xlsx",
                                    startRow = 4, sheetIndex = 1,
                                    colClasses = c(ID = 'numeric'),
                                    stringsAsFactors = FALSE))
names(respiratory) <- gsub("\\.", "", names(respiratory)) # remove periods '.'
respiratory <- respiratory[-nrow(respiratory),] %>%
  select(ID, Medications)

```

## Convert data

```{r}
# Calculate age
# 
# By default, calculates the typical "age in years", with a
# \code{floor} applied so that you are, e.g., 5 years old from
# 5th birthday through the day before your 6th birthday. Set
# \code{floor = FALSE} to return decimal ages, and change \code{units}
# for units other than years.
# @param dob date-of-birth, the day to start calculating age.
# @param age.day the date on which age is to be calculated.
# @param units unit to measure age in. Defaults to \code{"years"}. Passed to \link{\code{duration}}.
# @param floor boolean for whether or not to floor the result. Defaults to \code{TRUE}.
# @return Age in \code{units}. Will be an integer if \code{floor = TRUE}.
# @examples
# my.dob <- as.Date('1983-10-20')
# age(my.dob)
# age(my.dob, units = "minutes")
# age(my.dob, floor = FALSE)
# code by 'Gregor' 
# https://stackoverflow.com/questions/27096485/change-a-column-from-birth-date-to-age-in-r
# requires library 'lubridate'

age <- function(dob, age.day = today(), units = "years", floor = TRUE) {
  calc.age = interval(dob, age.day) / duration(num = 1, units = units)
  if (floor) return(as.integer(floor(calc.age)))
  return(calc.age)
}

population <- population %>%
  # add columns for whether they have seen the doctor who is making the telephone calls
  # or are of known refugee or asylum seeker background
  # (?proxy for low English language literacy)
  mutate(RefugeeOrAsylum = ID %in% refugeeorasylum$INTERNALID,
         analgesia = ID %in% analgesia$ID,
         BP = ID %in% BP$ID,
         anticoagulant = ID %in% anticoagulant$ID,
         antipsychoticmood = ID %in% antipsychoticmood$ID,
         antidepressant = ID %in% antidepressant$ID,
         antianxiety = ID %in% antianxiety$ID,
         respiratory = ID %in% respiratory$ID,
         DOB = as.Date(substr(DOBAge, 1, 10), format = "%d/%m/%Y")) %>% 
  mutate(Age = age(DOB, age.day = as.Date("2020/02/01"))) %>%
  # note that age is on 1st Feb 2020
  mutate(AgeGroup10 = ((Age %/% 10)*10)) # 10-year age groups, labelled with minimum age

population %>%
  select(c(DOB, Age, Sex, RefugeeOrAsylum,
           analgesia, BP, anticoagulant, antipsychoticmood, antidepressant, antianxiety, respiratory,
           AgeGroup10)) %>%
  summary()

```

## Population overview

Number of patients at each age group, and recorded gender.

```{r}
ggplot(population, aes(x = Age, fill=Sex)) +
  geom_histogram(binwidth = 5, boundary = 25) +
  xlab("Age (years)") +
  ggtitle("Patients with ")
```

Total population : `r nrow(population)`



```{r}
medcount_age10 <- as.data.frame.matrix(table(population$MedCount, population$AgeGroup10))

Totals <- medcount_age10 %>%
  mutate(Total = select(., `0`:`90`) %>% apply(1, sum, na.rm = TRUE)) %>%
  pull(Total)

medcount_age10 %>% 
  mutate(MedCount = row.names(.)) %>%
  mutate_if(is.numeric, function(x) {color_tile("#DeF7E9", "#71CA97")(x)}) %>%
  select(MedCount, everything()) %>%
  mutate(Total = Totals) %>%
  kable("html", align = c("l", rep("r", 11)),
        escape = F) %>%
  kable_styling("hover", full_width = FALSE) %>%
  column_spec(c(2,3,4,5,6,7,8, 9, 10, 11), width = "1.5cm", bold = TRUE) %>%
  add_header_above(c(" ", "Age group (decade)" = 10, " "))
```


```{r}

population <- population %>%
  filter(Age >= 50 & Age <= 89) %>%
  filter(MedCount >= 8)

mc_refugeeorasylum <- as.data.frame.matrix(table(population$MedCount, population$RefugeeOrAsylum)) %>%
  select(Refugee = `TRUE`)
mc_analgesia <- as.data.frame.matrix(table(population$MedCount, population$analgesia)) %>%
  select(Analgesia = `TRUE`)
mc_BP <- as.data.frame.matrix(table(population$MedCount, population$BP)) %>%
  select(BP = `TRUE`)
mc_anticoagulant <- as.data.frame.matrix(table(population$MedCount, population$anticoagulant)) %>%
  select(anticoagulant = `TRUE`)
mc_antipsychoticmood <- as.data.frame.matrix(table(population$MedCount, population$antipsychoticmood)) %>%
  select(antipsychotic = `TRUE`)
mc_antidepressant <- as.data.frame.matrix(table(population$MedCount, population$antidepressant)) %>%
  select(antidepressant = `TRUE`)
mc_antianxiety <- as.data.frame.matrix(table(population$MedCount, population$antianxiety)) %>%
  select(antianxiety = `TRUE`)
mc_respiratory <- as.data.frame.matrix(table(population$MedCount, population$respiratory)) %>%
  select(respiratory = `TRUE`)
mc_conditions <- cbind(mc_refugeeorasylum, mc_analgesia, mc_BP,
                       mc_anticoagulant, mc_antipsychoticmood, mc_antidepressant,
                       mc_antianxiety, mc_respiratory)

mc_conditions %>% 
  mutate(MedCount = row.names(.)) %>%
  mutate_if(is.numeric, function(x) {color_tile("#DeF7E9", "#71CA97")(x)}) %>%
  select(MedCount, everything()) %>%
  kable("html", align = c("l", rep("r", 8)),
        escape = F) %>%
  kable_styling("hover", full_width = FALSE) %>%
  column_spec(c(2,3,4,5,6,7,8,9), width = "2cm", width_min = "1.5cm", bold = TRUE) %>%
  add_header_above(c(" ", "Conditions" = 8))

```


## Choosing treatment and control groups


```{r}
set.seed(215936)
# set random number seed
# chosen by time on my watch at that particular second

# balance across possible co-variants of age (10),
# refugee/asylum seeker, analgesia, BP, antidepressant

# use 'createDataPartition' function from 'caret' library

population <- population %>%
  mutate(Subgroup = RefugeeOrAsylum + analgesia * 2 +
           BP * 4 + antidepressant * 8)

phase1 <- NULL
phase2 <- NULL

for (i in sort(unique(population$AgeGroup10))) {
  coinflip <- runif(1)>.5
  for (k in sort(unique(population$Subgroup))) {
    subsection <- population[population$AgeGroup10 == i & population$Subgroup == k,]
    if (nrow(subsection) > 0) {
      subsection$rank <- runif(nrow(subsection))
      if ((nrow(subsection) %% 2) == 1)
      {coinflip <- 1 - coinflip} # toggle from favouring treatment or control
      new_phase2 <- top_n(subsection, as.integer(nrow(subsection)/2 + coinflip*.5), rank)
      new_phase1 <- anti_join(subsection, new_phase2, by = "ID")
      phase2 <- rbind(phase2, new_phase2)
      phase1 <- rbind(phase1, new_phase1)
    }
  }
}

```

## Treatment ("Phase 1") group

```{r}
ggplot(treatment, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

## Control ("Phase 2") group

```{r}
ggplot(control, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

## Further divison according to 'survey' team

Two surveyors planned. One of whom will be Dr Buddini.
Divide each of treatment and survey groups into two sub-groups.

```{r}
set.seed(1603104944)

treatment1 <- NULL
treatment2 <- NULL

for (i in levels(treatment$AgeGroup5)) {
  coinflip <- runif(1)>.5
  for (j in levels(treatment$Subgroup)) {
    subsection <- treatment[treatment$AgeGroup5 == i & treatment$Subgroup == j,]
    subsection$rank <- runif(nrow(subsection))
    if ((nrow(subsection) %% 2) == 1)
    {coinflip <- 1 - coinflip} # toggle from favouring one group or another
    new_treatment1 <- top_n(subsection, as.integer(nrow(subsection)/2 + coinflip*.5), rank)
    new_treatment2 <- anti_join(subsection, new_treatment1, by = "INTERNALID")
    treatment1 <- rbind(treatment1, new_treatment1)
    treatment2 <- rbind(treatment2, new_treatment2)
  }
}

control1 <- NULL
control2 <- NULL

for (i in levels(control$AgeGroup5)) {
  coinflip <- runif(1)>.5
  for (j in levels(control$Subgroup)) {
    subsection <- control[control$AgeGroup5 == i & control$Subgroup == j,]
    subsection$rank <- runif(nrow(subsection))
    if ((nrow(subsection) %% 2) == 1)
    {coinflip <- 1 - coinflip} # toggle from favouring one group or another
    new_control1 <- top_n(subsection, as.integer(nrow(subsection)/2 + coinflip*.5), rank)
    new_control2 <- anti_join(subsection, new_control1, by = "INTERNALID")
    control1 <- rbind(control1, new_control1)
    control2 <- rbind(control2, new_control2)
  }
}

```

Treatment ("Phase 1") group 1

```{r}
ggplot(treatment1, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

Treatment ("Phase 1") group 2

```{r}
ggplot(treatment2, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

Control ("Phase 2") group 1

```{r}
ggplot(control1, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

Control ("Phase 2") group 2

```{r}
ggplot(control2, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

## Export sub-groups to files for surveyor use.

### Excel file

Re-attach patient names and demographic details to
sub-groups, and export to Excel file (Phase 1 = Treat, Phase 2 = Control) for use by
surveyors.

#### Variables added

* *Surveyor* : person conducting telephone contact
* *Ineligible* : reason (if appropriate) ineligible for Cervical Screening Test (CST) e.g. hysterectomy 
* *Interpreter needed* and *Interpreter used* : indicated in file that interpreter required? interpreter used?
* *Previously seen by* : Person previously seen by surveyor?
* *Phone Attempts* : Number of phone attempts
* *Message left* : Was message left?
* *Contact made* : was in-person contact made?
* *Decline appointment - why* : reason appointment declined
* *External result sought* : cervical screening test done elsewhere? sought?
* *Accepted appointment* : Appointment made at coHealth Kensington for CST?
* *Date of Appt* : Date of appointment made for CST
* *Attended Appt* : Appointment attended?
* *Screening Completed* : Cervical screening actually done at attended appointment?
* *Result* : Result of cervical screening

```{r eval = FALSE}
# set {r eval = FALSE when 'knitting' to form a HTML file}
# as identifying data should not be in a public space!

RecordingVariables <- matrix(c("Surveyor", "Ineligible - reason", "Interpreter needed", "Interpreter used",
                               "Previously seen by", "Phone attempts", "Message left", "Contact made",
                               "Declined appt - why", "External result sought",
                               "Accepted appt", "Date of appt", "Attended appt",
                               "Screening completed", "Result"), nrow = 1, byrow = FALSE)
# list of recording variables to add to Excel sheets

patient_details <- read.csv("20190401CSTpopulation_details.csv")
# file with patient details
patient_details <- patient_details %>%
  select(c("INTERNALID", "SURNAME", "FIRSTNAME", "MIDDLENAME", "PREFERREDNAME", "TITLE", "DOB", "AGE", "RECORDNO"))
# select columns required for export

treatment1_details <- treatment1 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups in separate sheets
  left_join(patient_details, by = "INTERNALID")

treatment2_details <- treatment2 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups treatment in separate sheets
  left_join(patient_details, by = "INTERNALID")

control1_details <- control1 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups in separate sheets
  left_join(patient_details, by = "INTERNALID")

control2_details <- control2 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups in separate sheets
  left_join(patient_details, by = "INTERNALID")

wb_treat <- createWorkbook() # create blank workbook

for (i in levels(treatment1_details$AgeGroup5)) {
  subsection1 <- treatment1_details[treatment1_details$AgeGroup5 == i,]
  sheetname1 <- paste("Phase 1 Group 1 - ", i)
  addWorksheet(wb_treat, sheetname1)
  writeData(wb_treat, sheetname1, subsection1)
  writeData(wb_treat, sheetname1, RecordingVariables, startCol = 12, colNames = FALSE)
  subsection2 <- treatment2_details[treatment2_details$AgeGroup5 == i,]
  sheetname2 <- paste("Phase 1 Group 2 - ", i)
  addWorksheet(wb_treat, sheetname2)
  writeData(wb_treat, sheetname2, subsection2)
  writeData(wb_treat, sheetname2, RecordingVariables, startCol = 12, colNames = FALSE)
}

saveWorkbook(wb_treat, file = "20190401CSTPhase1Groups.xlsx", overwrite = TRUE)

wb_control <- createWorkbook() # create blank workbook

for (i in levels(control1_details$AgeGroup5)) {
  subsection1 <- control1_details[control1_details$AgeGroup5 == i,]
  sheetname1 <- paste("Phase 2 Group 1 - ", i)
  addWorksheet(wb_control, sheetname1)
  writeData(wb_control, sheetname1, subsection1)
  writeData(wb_control, sheetname1, RecordingVariables, startCol = 12, colNames = FALSE)
  subsection2 <- control2_details[control2_details$AgeGroup5 == i,]
  sheetname2 <- paste("Phase 2 Group 2 - ", i)
  addWorksheet(wb_control, sheetname2)
  writeData(wb_control, sheetname2, subsection2)
  writeData(wb_control, sheetname2, RecordingVariables, startCol = 12, colNames = FALSE)
}

saveWorkbook(wb_control, file = "20190401CSTPhase2Groups.xlsx", overwrite = TRUE)


```

### SurveyCTO lists

```{r eval = FALSE}
# first row has three compulsory titles
# 'id' - This is the unique ID that identifies each case
#   use INTERNALID
# 'label' - This is the label that will be used to identify each case when shown in Collect's user interface
#   use INTERNALID + Initials + RECORDNO (unfortunately not all listed patients have a RECORDNO)
# 'formids' - This is the comma-separated list of unique form ID's that are associated with a case
#   this will be 'cervical_screening_questionnaire'

surveycto_treatment <- rbind(treatment1_details, treatment2_details) %>%
  select(c("INTERNALID", "FIRSTNAME", "SURNAME", "RECORDNO")) %>%
  mutate(label = paste0(substring(FIRSTNAME, 1, 1), substring(SURNAME, 1, 1), " ",
                        INTERNALID, " ", RECORDNO, " ")) %>%
  mutate(formids = c("cervical_screening_questionnaire")) %>%
  rename(id = INTERNALID) %>%
  select(c("id", "label", "formids"))

write.csv(surveycto_treatment, file = "20190401CSTsurveyCTO_Phase1.csv",
          row.names = FALSE)

surveycto_control <- rbind(control1_details, control2_details) %>%
  select(c("INTERNALID", "FIRSTNAME", "SURNAME", "RECORDNO")) %>%
  mutate(label = paste0(substring(FIRSTNAME, 1, 1), substring(SURNAME, 1, 1), " ",
                        INTERNALID, " ", RECORDNO, " ")) %>%
  mutate(formids = c("cervical_screening_questionnaire")) %>%
  rename(id = INTERNALID) %>%
  select(c("id", "label", "formids"))

write.csv(surveycto_control, file = "20190401CSTsurveyCTO_Phase2.csv",
          row.names = FALSE)

```


## SQL code

### Finding patients eligible for the study

Find eligible patients (female, age criteria), who are active patients (defined
by three or more contacts in the past two years, including one *billed* visit in
the past six months), who have not had cervical screening detected found in the
PapSmear table or the Investigations table.

Note that there is another table 'ObGyn' which should contain the most recent
cervical screening result, but unfortunately, 'over-chose' 5 patients (found 295
patients, instead of '290' as found using this search.)

```{sql eval = FALSE}
SELECT *

FROM BPS_Patients
WHERE StatusText = 'Active'
AND Sex = 'Female'
AND DOB BETWEEN  DateAdd(Year,-75,'20190401') AND DateAdd(Year,-25,'20190401')

AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'),
('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),('%maxwell%'),
('%grace ho%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name

WHERE VisitDate BETWEEN DateAdd(Month,-25,'20190401') AND '20190401'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 3)

AND InternalID IN (SELECT InternalID
FROM Invoices WHERE InvoiceID IN (SELECT InvoiceID
FROM Services
WHERE Recordstatus = 1
AND Servicedate > DateAdd(Month, -7, '20190401'))) 

AND InternalID NOT IN (SELECT InternalID
FROM PapSmears
WHERE PapDate > DATEADD(Month, -45, '20190401')
-- CST not extremely overdue (>45 months old)
)
AND InternalID NOT IN (SELECT InternalID
FROM Investigations
WHERE (
TestName LIKE '%CERVICAL SCREENING%'
OR TestName LIKE '%PAP SMEAR%')
AND ReportDate >  DATEADD(Month, -45, '20190401')
-- alternative search for Cervical Screening in Investigations (does not always appear in PAP table)
)
AND InternalID NOT IN (SELECT InternalID
FROM ObsGynDetail
WHERE NoPap=1
-- for some reason, Pap/CST marked as no longer required
)

ORDER BY surname, firstname

```

#### Additional code to detect if recorded history of refugee or asylum seeker status

```{sql eval = FALSE}
AND (
InternalID IN
(SELECT InternalID FROM PastHistory WHERE ItemCode = 13155 AND RecordStatus = 1)
OR 
InternalID IN 
(SELECT InternalID FROM PastHistory WHERE ItemCode = 13154 AND RecordStatus = 1)
)
```

#### Additional code to detect if contacted by a specific clinician (Dr Buddini).

```{sql eval = FALSE}
AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%ekanayake%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name
WHERE VisitDate BETWEEN DateAdd(Month,-25,'20190401') AND '20190401'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 1)
```

### Finding historical cervical screening rates among the under-screened

Below code finds 'active' patients (5 contacts in two years, include one
contact within the previous six months) preceding 1st March 2018. Excludes
patients who are marked for 'no cervical screening'.

Note that the 'recent' visit definition is different to seeking patients
eligible for the study, because no billing data is available prior to 
June 2018.

It then further restricts the patients to those who had a cervical
screening test in the next three months.

```{sql eval = FALSE}
SELECT *

FROM BPS_Patients
WHERE StatusText = 'Active'
AND Sex = 'Female'
AND DOB BETWEEN  DateAdd(Year,-75,'20180301') AND DateAdd(Year,-25,'20180301')

AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'),
('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),('%maxwell%'),
('%grace ho%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name

WHERE VisitDate BETWEEN DateAdd(Year,-2,'20180301') AND '20180301'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 3)

AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'),
('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),('%maxwell%'),
('%grace ho%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name

WHERE VisitDate BETWEEN DateAdd(Month,-6,'20180301') AND '20180301'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 1)

AND InternalID NOT IN (SELECT InternalID
FROM PapSmears
WHERE PapDate > DATEADD(Month, -45, '20180301')
AND PapDate < '20180301'
-- CST not extremely overdue (>45 months old)
)
AND InternalID NOT IN (SELECT InternalID
FROM Investigations
WHERE (
TestName LIKE '%CERVICAL SCREENING%'
OR TestName LIKE '%PAP SMEAR%')
AND ReportDate >  DATEADD(Month, -45, '20180301')
AND ReportDate <  '20180301'

-- alternative search for Cervical Screening in Investigations (does not always appear in PAP table)
)
AND (InternalID IN (SELECT InternalID
FROM PapSmears
WHERE PapDate >= '20180301'
AND PapDate < DATEADD(Month, 3, '20180301')
-- CST done in next three months
)
OR InternalID IN (SELECT InternalID
FROM Investigations
WHERE (
TestName LIKE '%CERVICAL SCREENING%'
OR TestName LIKE '%PAP SMEAR%')
AND ReportDate >  '20180301'
AND ReportDate <  DATEADD(Month, 3, '20180301')

-- alternative search for Cervical Screening in Investigations (does not always appear in PAP table)
))
AND InternalID NOT IN (SELECT InternalID
FROM ObsGynDetail
WHERE NoPap=1
-- for some reason, Pap/CST marked as no longer required
)

ORDER BY surname, firstname
```