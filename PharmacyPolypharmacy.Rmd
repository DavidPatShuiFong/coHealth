---
title: "Polypharmacy"
author: "Dr. David Fong"
date: "6th February 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Cervical screening benefits

Regular cervical cancer screening reduces the risk of cancer incidence by approximately a factor of 3 to 4 compared to no screening (for women aged 35 to 79 years), and reduces mortality by a factor of 4 to 10. Regular cervical cancer screening reduces the risk of cervical cancer incidence and death by up to a factor of two compared to irregular cervical cancer screening[^1].

[^1]:“Impact of cervical screening on cervical cancer mortality: estimation using stage-specific results from a nested case-control study” Landy, Pesola, Castanon and Sasieni. British Journal of Cancer (2016) **115**, 1140-1146

## Extent of under-screening

According to Practice Incentive program data (May 2018), 61.14% of eligible patients at coHealth Kensington were screened appropriately for cervical cancer.

Using SQL searches in the Best Practice database, as of 1st March 2019 there were 857 eligible patients who were active in seeing the clinic. Of those, 290 patients (34%) had either no recording of a cervical screening, or no cervical screening recording for the previous forty-five months. At the time of writing, cervical screening done forty-five (45) or more months previously would be the 'Pap' smear, which needs to be repeated in twenty-four (24) months.

Note : For the purpose of this document, 'eligible' patients are females aged between 25 and 75 years, who are not otherwise marked as not requiring future cervical screening. 'Active' patients refers to patients who have had three or more contacts with the clinic in the previous twenty-five months, including at least once in the previous seven months. If the information is available (as it was in March 2019, but not in preceding years), the 'previous seven months' contact is a 'billed visit'.

### Rate of cervical screening in patients who are underscreened

The number of active and eligible patients who either had no history of screening or were very overdue (more than 45 months old screen, when screening is due every 24 months) as of 1st March 2018 was 270 patients.

Over the next three months, fourteen of those patients (5.2%) had a recorded cervical screening.

In the next three months after that, an additional ten patients (3.7%) had a recorded cervical screening.

SQL search code used to count historical screening found at the end of this document. Note that no billing information is available prior to June 2018, so the definition of an 'active' patient is slightly different.

## Current strategies to promote cervical screening.

During visits for other purposes in a primary care clinic, patients are, where possible, recommended to have cervical screening. This can be aided by automated 'real-time' tools such as Doctor's Control Panel, and the availability of a womens' health nurse who is available to do cervical screening.

In addition, the clinic runs a reminder system which invites patients to repeat the cervical screening when the next screening is due. This is done with a letter, in English. The government also uses letters to remind people when the next cervical screening is due. Until very recenty, the 'reminder' interval has been two years, as cervical screening was done with the 'Pap' test until 2018.

## Cervical screening outcome payment

Current eligible practice population : 754 (according to May 2018 PIP data)

Annual outcome payment : $3 per eligible patient = $2262. Never yet received

* Current cervical screening coverage rate (according to 2017 PIP data) = 61.14%
* Target Diabetes SIP claim rate to claim annual outcome payment = 70%

Potential additional Cervical SIP revenue, if target Cervical SIP claim rate achieved, assuming that half of additionally screened women can have a cervical SIP item claimed
= (70-61.14)/100 * 754 * $35 * 0.5 =  $1169.1

Additional revenue if Cervical Outcome Payment achieved
= $2262 (annual outcome payment) + $1169.1 (additional cervical SIP revenue)
= $3431.1

# Cervical Screening and intensive telephone-based case-finding

## Methods

* Identify active eligible women who either have no recorded cervical screening or whose last recorded screening is very overdue (most recent result 45 months or older)
* One of two surveyors (Dr Buddini, or womens' health nurse) will invite the woman to participate in cervical screening. The invitation will be done by telephone, using a telephone interpreter if required.
* If the invitation is accepted, an appointment is made for cervical screening.

```{r message = FALSE, results = 'hide', warning = FALSE}
library(tidyverse)
library(lubridate)
library(xlsx)
library(openxlsx)
library(esquisse)
```

## Logframe



## Variables to measure

* **Age**
* **Refugee or asylum seeker** Possible proxy for less English literacy skills, or different health literacy.

# Data and Code

## Read Data

```{r}
population <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002Medication5plus.xlsx",
                                   startRow = 4, sheetIndex = 1,
                                   colClasses = c(ID = 'numeric'),
                                   stringsAsFactors = FALSE))
names(population) <- gsub("\\.", "", names(population)) # remove periods '.'
population <- population[-nrow(population),] %>%
  mutate(MedCount = as.numeric(MedCount))

refugeeorasylum <- as_tibble(read.csv("../../PEN Clinical Audit/20200206RefugeeAsylum.csv",
                                      stringsAsFactors = FALSE,
                                      colClasses = c(INTERNALID = 'numeric'))) %>%
  select(INTERNALID)

analgesia <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAnalgesia.xlsx",
                                  startRow = 4, sheetIndex = 1,
                                  colClasses = c(ID = 'numeric'),
                                  stringsAsFactors = FALSE))
names(analgesia) <- gsub("\\.", "", names(analgesia)) # remove periods '.'
analgesia <- analgesia[-nrow(analgesia),] %>%
  select(ID, Medications)

BP <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationBP.xlsx",
                           startRow = 4, sheetIndex = 1,
                           colClasses = c(ID = 'numeric'),
                           stringsAsFactors = FALSE))
names(BP) <- gsub("\\.", "", names(BP)) # remove periods '.'
BP <- BP[-nrow(BP),] %>%
  select(ID, Medications)

anticoagulant <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAnticoagulant.xlsx",
                                      startRow = 4, sheetIndex = 1,
                                      colClasses = c(ID = 'numeric'),
                                      stringsAsFactors = FALSE))
names(anticoagulant) <- gsub("\\.", "", names(anticoagulant)) # remove periods '.'
anticoagulant <- anticoagulant[-nrow(anticoagulant),] %>%
  select(ID, Medications)

hypoglycaemic <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationHypoglycaemic.xlsx",
                                      startRow = 4, sheetIndex = 1,
                                      colClasses = c(ID = 'numeric'),
                                      stringsAsFactors = FALSE))
names(hypoglycaemic) <- gsub("\\.", "", names(hypoglycaemic)) # remove periods '.'
hypoglycaemic <- hypoglycaemic[-nrow(hypoglycaemic),] %>%
  select(ID, Medications)

antipsychoticmood <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAntipsychoticMoodStabilizers.xlsx",
                                          startRow = 4, sheetIndex = 1,
                                          colClasses = c(ID = 'numeric'),
                                          stringsAsFactors = FALSE))
names(antipsychoticmood) <- gsub("\\.", "", names(antipsychoticmood)) # remove periods '.'
antipsychoticmood <- antipsychoticmood[-nrow(antipsychoticmood),] %>%
  select(ID, Medications)

antidepressant <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAntidepressant.xlsx",
                                       startRow = 4, sheetIndex = 1,
                                       colClasses = c(ID = 'numeric'),
                                       stringsAsFactors = FALSE))
names(antidepressant) <- gsub("\\.", "", names(antidepressant)) # remove periods '.'
antidepressant <- antidepressant[-nrow(antidepressant),] %>%
  select(ID, Medications)

antianxiety <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationAntianxiety.xlsx",
                                    startRow = 4, sheetIndex = 1,
                                    colClasses = c(ID = 'numeric'),
                                    stringsAsFactors = FALSE))
names(antianxiety) <- gsub("\\.", "", names(antianxiety)) # remove periods '.'
antianxiety <- antianxiety[-nrow(antianxiety),] %>%
  select(ID, Medications)

respiratory <- as_tibble(read.xlsx2("../../PEN Clinical Audit/202002MedicationRespiratory.xlsx",
                                    startRow = 4, sheetIndex = 1,
                                    colClasses = c(ID = 'numeric'),
                                    stringsAsFactors = FALSE))
names(respiratory) <- gsub("\\.", "", names(respiratory)) # remove periods '.'
respiratory <- respiratory[-nrow(respiratory),] %>%
  select(ID, Medications)

```

## Convert data

```{r}
#' Calculate age
#' 
#' By default, calculates the typical "age in years", with a
#' \code{floor} applied so that you are, e.g., 5 years old from
#' 5th birthday through the day before your 6th birthday. Set
#' \code{floor = FALSE} to return decimal ages, and change \code{units}
#' for units other than years.
#' @param dob date-of-birth, the day to start calculating age.
#' @param age.day the date on which age is to be calculated.
#' @param units unit to measure age in. Defaults to \code{"years"}. Passed to \link{\code{duration}}.
#' @param floor boolean for whether or not to floor the result. Defaults to \code{TRUE}.
#' @return Age in \code{units}. Will be an integer if \code{floor = TRUE}.
#' @examples
#' my.dob <- as.Date('1983-10-20')
#' age(my.dob)
#' age(my.dob, units = "minutes")
#' age(my.dob, floor = FALSE)
# code by 'Gregor' 
# https://stackoverflow.com/questions/27096485/change-a-column-from-birth-date-to-age-in-r
# requires library 'lubridate'
age <- function(dob, age.day = today(), units = "years", floor = TRUE) {
  calc.age = interval(dob, age.day) / duration(num = 1, units = units)
  if (floor) return(as.integer(floor(calc.age)))
  return(calc.age)
}

population <- population %>%
  # add columns for whether they have seen the doctor who is making the telephone calls
  # or are of known refugee or asylum seeker background
  # (?proxy for low English language literacy)
  mutate(RefugeeOrAsylum = ID %in% refugeeorasylum$INTERNALID,
         analgesia = ID %in% analgesia$ID,
         BP = ID %in% BP$ID,
         anticoagulant = ID %in% anticoagulant$ID,
         antipsychoticmood = ID %in% antipsychoticmood$ID,
         antidepressant = ID %in% antidepressant$ID,
         antianxiety = ID %in% antianxiety$ID,
         respiratory = ID %in% respiratory$ID,
         DOB = as.Date(substr(DOBAge, 1, 10), format = "%d/%m/%Y")) %>% 
  mutate(Age = age(DOB, age.day = as.Date("2020/02/01"))) %>%
  # note that age is on 1st Feb 2020
  mutate(AgeGroup10 = ((Age %/% 10)*10)) # 10-year age groups, labelled with minimum age

population %>%
  select(c(DOB, Age, Sex, RefugeeOrAsylum,
           analgesia, BP, anticoagulant, antipsychoticmood, antidepressant, antianxiety, respiratory,
           AgeGroup10)) %>%
  summary()

```

## Population overview

Number of patients at each age group, and whether they have a recorded
refugee or asylum seeker background or seen by Dr Buddini in the past
two years.

```{r}
ggplot(population, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 25)
```

Total population : `r nrow(population)`

### Power calculation

Previous proportion of under-screened patients who were screened in the three months after March 2018 was 5.2%. With a populaton of 290 patients, split between two groups, power of 0.8 and significance level of 0.05:

```{r}
power_3month <- power.prop.test(n = nrow(population)/2,
                                p1 = 0.05185,
                                # the measured proportion with recorded cervical screen
                                # under 'control' conditions
                                power=0.8, sig.level=0.05,
                                alternative = "two.sided")

power_3month

paste("Minimum detectable effect : ", power_3month$p2 - power_3month$p1)

```

This is similar to estimated minimum detectable effect size using the equation:

$EffectSize = (t_{1-\kappa}+t_\alpha)*\sqrt{\frac{1}{P(1-P)}}*\sqrt{\frac{\sigma^2}{N}}$

where $t_{1-\kappa}$ is the power, $t_\alpha$ is the significance level, $P$ is the proportion in treatment, $\sigma^2$ is the variance and $N$ is the sample size.

```{r}
p1 <- 0.05185        # our previously observed proportion of women
# who had cervical screening (CST) over three months
p2 <- 0.1482171    # our 'guess' of what the 'treatment' group who had CST over
# three months. this guess was actually informed by
# above power calculation, however!
p_avg <- (p1+p2)/2 # the average proportion of women who might
# have cervical screening at the end of the study
# variance of binomial is p(1-p)

abs(qnorm(0.8)+qnorm(0.975))*sqrt(1/((0.5)*(1-0.5)))*sqrt((p_avg)*(1-p_avg)/302)
```

Previous proportion of under-screened patients who were screened in the six months after March 2018 was 8.9%. With a populaton of 290 patients, split between two groups, power of 0.8 and significance level of 0.05:

```{r}
power.prop.test(n = nrow(population)/2,
                p1 = 0.08889,
                # the measured proportion with recorded cervical screen
                # under 'control' conditions
                power=0.8, sig.level=0.05,
                alternative = "two.sided")
```

## Choosing treatment and control groups

Complete randomization within sub-groups defined by age (5 years groups),
of known refugee or asylum seeker background, and whether seen by 
Dr Buddini in the past twenty-five months.

```{r}
set.seed(215936)
# set random number seed
# chosen by time on my watch at that particular second

# balance across possible co-variants of age,
# refugee/asylum seeker and whether seen by Dr Buddini in past two years

# use 'createDataPartition' function from 'caret' library

treatment <- NULL
control <- NULL

for (i in levels(population$AgeGroup5)) {
  coinflip <- runif(1)>.5
  for (j in levels(population$Subgroup)) {
    subsection <- population[population$AgeGroup5 == i & population$Subgroup == j,]
    subsection$rank <- runif(nrow(subsection))
    if ((nrow(subsection) %% 2) == 1)
    {coinflip <- 1 - coinflip} # toggle from favouring treatment or control
    new_control <- top_n(subsection, as.integer(nrow(subsection)/2 + coinflip*.5), rank)
    new_treatment <- anti_join(subsection, new_control, by = "INTERNALID")
    control <- rbind(control, new_control)
    treatment <- rbind(treatment, new_treatment)
  }
}

```

## Treatment ("Phase 1") group

```{r}
ggplot(treatment, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

## Control ("Phase 2") group

```{r}
ggplot(control, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

## Further divison according to 'survey' team

Two surveyors planned. One of whom will be Dr Buddini.
Divide each of treatment and survey groups into two sub-groups.

```{r}
set.seed(1603104944)

treatment1 <- NULL
treatment2 <- NULL

for (i in levels(treatment$AgeGroup5)) {
  coinflip <- runif(1)>.5
  for (j in levels(treatment$Subgroup)) {
    subsection <- treatment[treatment$AgeGroup5 == i & treatment$Subgroup == j,]
    subsection$rank <- runif(nrow(subsection))
    if ((nrow(subsection) %% 2) == 1)
    {coinflip <- 1 - coinflip} # toggle from favouring one group or another
    new_treatment1 <- top_n(subsection, as.integer(nrow(subsection)/2 + coinflip*.5), rank)
    new_treatment2 <- anti_join(subsection, new_treatment1, by = "INTERNALID")
    treatment1 <- rbind(treatment1, new_treatment1)
    treatment2 <- rbind(treatment2, new_treatment2)
  }
}

control1 <- NULL
control2 <- NULL

for (i in levels(control$AgeGroup5)) {
  coinflip <- runif(1)>.5
  for (j in levels(control$Subgroup)) {
    subsection <- control[control$AgeGroup5 == i & control$Subgroup == j,]
    subsection$rank <- runif(nrow(subsection))
    if ((nrow(subsection) %% 2) == 1)
    {coinflip <- 1 - coinflip} # toggle from favouring one group or another
    new_control1 <- top_n(subsection, as.integer(nrow(subsection)/2 + coinflip*.5), rank)
    new_control2 <- anti_join(subsection, new_control1, by = "INTERNALID")
    control1 <- rbind(control1, new_control1)
    control2 <- rbind(control2, new_control2)
  }
}

```

Treatment ("Phase 1") group 1

```{r}
ggplot(treatment1, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

Treatment ("Phase 1") group 2

```{r}
ggplot(treatment2, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

Control ("Phase 2") group 1

```{r}
ggplot(control1, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

Control ("Phase 2") group 2

```{r}
ggplot(control2, aes(x = Age, fill=Subgroup)) +
  geom_histogram(binwidth = 5, boundary = 24.95)
```

## Export sub-groups to files for surveyor use.

### Excel file

Re-attach patient names and demographic details to
sub-groups, and export to Excel file (Phase 1 = Treat, Phase 2 = Control) for use by
surveyors.

#### Variables added

* *Surveyor* : person conducting telephone contact
* *Ineligible* : reason (if appropriate) ineligible for Cervical Screening Test (CST) e.g. hysterectomy 
* *Interpreter needed* and *Interpreter used* : indicated in file that interpreter required? interpreter used?
* *Previously seen by* : Person previously seen by surveyor?
* *Phone Attempts* : Number of phone attempts
* *Message left* : Was message left?
* *Contact made* : was in-person contact made?
* *Decline appointment - why* : reason appointment declined
* *External result sought* : cervical screening test done elsewhere? sought?
* *Accepted appointment* : Appointment made at coHealth Kensington for CST?
* *Date of Appt* : Date of appointment made for CST
* *Attended Appt* : Appointment attended?
* *Screening Completed* : Cervical screening actually done at attended appointment?
* *Result* : Result of cervical screening

```{r eval = FALSE}
# set {r eval = FALSE when 'knitting' to form a HTML file}
# as identifying data should not be in a public space!

RecordingVariables <- matrix(c("Surveyor", "Ineligible - reason", "Interpreter needed", "Interpreter used",
                               "Previously seen by", "Phone attempts", "Message left", "Contact made",
                               "Declined appt - why", "External result sought",
                               "Accepted appt", "Date of appt", "Attended appt",
                               "Screening completed", "Result"), nrow = 1, byrow = FALSE)
# list of recording variables to add to Excel sheets

patient_details <- read.csv("20190401CSTpopulation_details.csv")
# file with patient details
patient_details <- patient_details %>%
  select(c("INTERNALID", "SURNAME", "FIRSTNAME", "MIDDLENAME", "PREFERREDNAME", "TITLE", "DOB", "AGE", "RECORDNO"))
# select columns required for export

treatment1_details <- treatment1 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups in separate sheets
  left_join(patient_details, by = "INTERNALID")

treatment2_details <- treatment2 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups treatment in separate sheets
  left_join(patient_details, by = "INTERNALID")

control1_details <- control1 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups in separate sheets
  left_join(patient_details, by = "INTERNALID")

control2_details <- control2 %>%
  select(c("INTERNALID", "AgeGroup5")) %>% 
  # will store AgeGroup5 groups in separate sheets
  left_join(patient_details, by = "INTERNALID")

wb_treat <- createWorkbook() # create blank workbook

for (i in levels(treatment1_details$AgeGroup5)) {
  subsection1 <- treatment1_details[treatment1_details$AgeGroup5 == i,]
  sheetname1 <- paste("Phase 1 Group 1 - ", i)
  addWorksheet(wb_treat, sheetname1)
  writeData(wb_treat, sheetname1, subsection1)
  writeData(wb_treat, sheetname1, RecordingVariables, startCol = 12, colNames = FALSE)
  subsection2 <- treatment2_details[treatment2_details$AgeGroup5 == i,]
  sheetname2 <- paste("Phase 1 Group 2 - ", i)
  addWorksheet(wb_treat, sheetname2)
  writeData(wb_treat, sheetname2, subsection2)
  writeData(wb_treat, sheetname2, RecordingVariables, startCol = 12, colNames = FALSE)
}

saveWorkbook(wb_treat, file = "20190401CSTPhase1Groups.xlsx", overwrite = TRUE)

wb_control <- createWorkbook() # create blank workbook

for (i in levels(control1_details$AgeGroup5)) {
  subsection1 <- control1_details[control1_details$AgeGroup5 == i,]
  sheetname1 <- paste("Phase 2 Group 1 - ", i)
  addWorksheet(wb_control, sheetname1)
  writeData(wb_control, sheetname1, subsection1)
  writeData(wb_control, sheetname1, RecordingVariables, startCol = 12, colNames = FALSE)
  subsection2 <- control2_details[control2_details$AgeGroup5 == i,]
  sheetname2 <- paste("Phase 2 Group 2 - ", i)
  addWorksheet(wb_control, sheetname2)
  writeData(wb_control, sheetname2, subsection2)
  writeData(wb_control, sheetname2, RecordingVariables, startCol = 12, colNames = FALSE)
}

saveWorkbook(wb_control, file = "20190401CSTPhase2Groups.xlsx", overwrite = TRUE)


```

### SurveyCTO lists

```{r eval = FALSE}
# first row has three compulsory titles
# 'id' - This is the unique ID that identifies each case
#   use INTERNALID
# 'label' - This is the label that will be used to identify each case when shown in Collect's user interface
#   use INTERNALID + Initials + RECORDNO (unfortunately not all listed patients have a RECORDNO)
# 'formids' - This is the comma-separated list of unique form ID's that are associated with a case
#   this will be 'cervical_screening_questionnaire'

surveycto_treatment <- rbind(treatment1_details, treatment2_details) %>%
  select(c("INTERNALID", "FIRSTNAME", "SURNAME", "RECORDNO")) %>%
  mutate(label = paste0(substring(FIRSTNAME, 1, 1), substring(SURNAME, 1, 1), " ",
                        INTERNALID, " ", RECORDNO, " ")) %>%
  mutate(formids = c("cervical_screening_questionnaire")) %>%
  rename(id = INTERNALID) %>%
  select(c("id", "label", "formids"))

write.csv(surveycto_treatment, file = "20190401CSTsurveyCTO_Phase1.csv",
          row.names = FALSE)

surveycto_control <- rbind(control1_details, control2_details) %>%
  select(c("INTERNALID", "FIRSTNAME", "SURNAME", "RECORDNO")) %>%
  mutate(label = paste0(substring(FIRSTNAME, 1, 1), substring(SURNAME, 1, 1), " ",
                        INTERNALID, " ", RECORDNO, " ")) %>%
  mutate(formids = c("cervical_screening_questionnaire")) %>%
  rename(id = INTERNALID) %>%
  select(c("id", "label", "formids"))

write.csv(surveycto_control, file = "20190401CSTsurveyCTO_Phase2.csv",
          row.names = FALSE)

```


## SQL code

### Finding patients eligible for the study

Find eligible patients (female, age criteria), who are active patients (defined
by three or more contacts in the past two years, including one *billed* visit in
the past six months), who have not had cervical screening detected found in the
PapSmear table or the Investigations table.

Note that there is another table 'ObGyn' which should contain the most recent
cervical screening result, but unfortunately, 'over-chose' 5 patients (found 295
patients, instead of '290' as found using this search.)

```{sql eval = FALSE}
SELECT *

FROM BPS_Patients
WHERE StatusText = 'Active'
AND Sex = 'Female'
AND DOB BETWEEN  DateAdd(Year,-75,'20190401') AND DateAdd(Year,-25,'20190401')

AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'),
('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),('%maxwell%'),
('%grace ho%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name

WHERE VisitDate BETWEEN DateAdd(Month,-25,'20190401') AND '20190401'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 3)

AND InternalID IN (SELECT InternalID
FROM Invoices WHERE InvoiceID IN (SELECT InvoiceID
FROM Services
WHERE Recordstatus = 1
AND Servicedate > DateAdd(Month, -7, '20190401'))) 

AND InternalID NOT IN (SELECT InternalID
FROM PapSmears
WHERE PapDate > DATEADD(Month, -45, '20190401')
-- CST not extremely overdue (>45 months old)
)
AND InternalID NOT IN (SELECT InternalID
FROM Investigations
WHERE (
TestName LIKE '%CERVICAL SCREENING%'
OR TestName LIKE '%PAP SMEAR%')
AND ReportDate >  DATEADD(Month, -45, '20190401')
-- alternative search for Cervical Screening in Investigations (does not always appear in PAP table)
)
AND InternalID NOT IN (SELECT InternalID
FROM ObsGynDetail
WHERE NoPap=1
-- for some reason, Pap/CST marked as no longer required
)

ORDER BY surname, firstname

```

#### Additional code to detect if recorded history of refugee or asylum seeker status

```{sql eval = FALSE}
AND (
InternalID IN
(SELECT InternalID FROM PastHistory WHERE ItemCode = 13155 AND RecordStatus = 1)
OR 
InternalID IN 
(SELECT InternalID FROM PastHistory WHERE ItemCode = 13154 AND RecordStatus = 1)
)
```

#### Additional code to detect if contacted by a specific clinician (Dr Buddini).

```{sql eval = FALSE}
AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%ekanayake%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name
WHERE VisitDate BETWEEN DateAdd(Month,-25,'20190401') AND '20190401'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 1)
```

### Finding historical cervical screening rates among the under-screened

Below code finds 'active' patients (5 contacts in two years, include one
contact within the previous six months) preceding 1st March 2018. Excludes
patients who are marked for 'no cervical screening'.

Note that the 'recent' visit definition is different to seeking patients
eligible for the study, because no billing data is available prior to 
June 2018.

It then further restricts the patients to those who had a cervical
screening test in the next three months.

```{sql eval = FALSE}
SELECT *

FROM BPS_Patients
WHERE StatusText = 'Active'
AND Sex = 'Female'
AND DOB BETWEEN  DateAdd(Year,-75,'20180301') AND DateAdd(Year,-25,'20180301')

AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'),
('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),('%maxwell%'),
('%grace ho%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name

WHERE VisitDate BETWEEN DateAdd(Year,-2,'20180301') AND '20180301'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 3)

AND InternalID IN (SELECT InternalID
FROM Visits v
INNER JOIN (VALUES('%bhagwat%'),('%fong%'),('%ekanayake%'),('%shoesmith%'),
('%plastow%'),('%samarawickrama%'),('%obeyesekere%'),('%chaves%'),
('%ryan%'),('%mikhail%'),('%haynes%'),('%buckwell%'),('%maxwell%'),
('%grace ho%'))
AS ProviderName(Name)
ON v.DrName LIKE ProviderName.Name

WHERE VisitDate BETWEEN DateAdd(Month,-6,'20180301') AND '20180301'
AND RecordStatus = 1

GROUP BY internalid
HAVING count(internalid) >= 1)

AND InternalID NOT IN (SELECT InternalID
FROM PapSmears
WHERE PapDate > DATEADD(Month, -45, '20180301')
AND PapDate < '20180301'
-- CST not extremely overdue (>45 months old)
)
AND InternalID NOT IN (SELECT InternalID
FROM Investigations
WHERE (
TestName LIKE '%CERVICAL SCREENING%'
OR TestName LIKE '%PAP SMEAR%')
AND ReportDate >  DATEADD(Month, -45, '20180301')
AND ReportDate <  '20180301'

-- alternative search for Cervical Screening in Investigations (does not always appear in PAP table)
)
AND (InternalID IN (SELECT InternalID
FROM PapSmears
WHERE PapDate >= '20180301'
AND PapDate < DATEADD(Month, 3, '20180301')
-- CST done in next three months
)
OR InternalID IN (SELECT InternalID
FROM Investigations
WHERE (
TestName LIKE '%CERVICAL SCREENING%'
OR TestName LIKE '%PAP SMEAR%')
AND ReportDate >  '20180301'
AND ReportDate <  DATEADD(Month, 3, '20180301')

-- alternative search for Cervical Screening in Investigations (does not always appear in PAP table)
))
AND InternalID NOT IN (SELECT InternalID
FROM ObsGynDetail
WHERE NoPap=1
-- for some reason, Pap/CST marked as no longer required
)

ORDER BY surname, firstname
```